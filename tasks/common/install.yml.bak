---
#######  Authentication setup #######

- name: Ensure Lotus group exists
  group:
    name: "{{ lotus_user }}"
    state: present
  become: true

- name: Create Lotus user
  user:
    comment: Lotus service account
    name: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
    create_home: "no"
  become: true

#######  Source installation #######

- name: Install system dependencies
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ system_dependencies }}"

- name: Download and extract Go-lang
  unarchive:
    src: "{{ go_url }}"
    dest: "{{ go_install_dir }}"
    owner: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
    mode: '0775'
    remote_src: yes
  become: true

- name: Add Go installation dir to system-wide $PATH
  copy:
    dest: /etc/profile.d/custom-path.sh
    content: 'PATH=$PATH:{{ go_install_dir }}/go/bin'
  become: true

- name: Create installation directory
  file:
    path: "{{ install_dir }}"
    state: directory
    owner: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
  become: true

- name: Clone lotus git repository
  git:
    repo: "{{ git_url }}"
    dest: "{{ install_dir }}"

- name: Reset state of source
  make:
    chdir: "{{ install_dir }}"
    target: clean

- name: Build source package
  make:
    chdir: "{{ install_dir }}"
    target: all

- name: Install lotus client and miner software
  make:
    chdir: "{{ install_dir }}"
    target: install
  become: true
